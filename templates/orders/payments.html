{% extends 'base.html' %}
{% load static %}
{% load l10n %}

{% block content %}

<section class="py-8 bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

      <!-- Recheck Details -->
      <div class="lg:col-span-3 space-y-6">

        <!-- Billing Address Preview -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Billing Address</h2>
          <div class="text-gray-700 space-y-1">
            <p>{{ order.first_name }} {{ order.last_name }}</p>
            <p>{{ order.address_line_1 }}</p>
            <p>{{ order.city }}, {{ order.state }}</p>
            <p>{{ order.country }}</p>
            <p>Email: {{ order.email }}</p>
            <p>Phone: {{ order.phone }}</p>
            {% if order.order_note %}
            <p class="italic text-gray-500">Note: {{ order.order_note }}</p>
            {% endif %}
          </div>
        </div>

        <!-- Payment Options -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Select Payment Method</h2>
          <div class="space-y-3">
            <label class="flex items-center space-x-2">
              <input type="radio" name="payment_option" value="paypal" checked>
              <span>Pay with PayPal</span>
            </label>
            <label class="flex items-center space-x-2">
              <input type="radio" name="payment_option" value="upi">
              <span>Pay with UPI (GPay, PhonePe, Paytm)</span>
            </label>
            <label class="flex items-center space-x-2">
              <input type="radio" name="payment_option" value="cod">
              <span>Cash on Delivery</span>
            </label>
          </div>
        </div>

        <!-- Ordered Products -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Ordered Products</h2>
          <div class="overflow-x-auto">
            <table class="w-full border border-gray-200 rounded-md">
              <thead class="bg-gray-50">
                <tr class="text-left text-sm font-medium text-gray-500 uppercase tracking-wider">
                  <th class="px-4 py-3">Product</th>
                  <th class="px-4 py-3 text-center">Quantity</th>
                  <th class="px-4 py-3 text-center">Price</th>
                  <th class="px-4 py-3 text-center">Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                {% for item in cart_items %}
                <tr>
                  <td class="px-4 py-3">
                    <div class="flex items-center space-x-4">
                      <img src="{{ item.product.product_image.url }}" class="w-12 h-12 object-cover rounded">
                      <div>
                        <p class="font-medium">{{ item.product.product_name }}</p>
                        {% for variation in item.variations.all %}
                        <p class="text-sm text-gray-500">
                          {{ variation.category.name | capfirst }}: {{ variation.value | capfirst }}
                        </p>
                        {% endfor %}
                      </div>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-center">{{ item.quantity }}</td>
                  <td class="px-4 py-3 text-center">${{ item.product.product_price|floatformat:2 }}</td>
                  <td class="px-4 py-3 text-center">${{ item.sub_total|floatformat:2 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Order Summary</h3>

          <div class="space-y-3 mb-6">
            <div class="flex justify-between">
              <span class="text-gray-600">Subtotal:</span>
              <span class="font-medium">${{ total|floatformat:2|unlocalize }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Delivery Charge:</span>
              <span class="font-medium">${{ delivery_charge|floatformat:2|unlocalize }}</span>
            </div>
            <hr class="border-gray-200">
            <div class="flex justify-between text-lg font-bold">
              <span>Total:</span>
              <span>${{ grand_total|floatformat:2|unlocalize }}</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <script
            src="https://www.paypal.com/sdk/js?client-id=AV_AByJjFGx3H95afZW-W6e1abIWT6UYEwZS3DszLjIvC7poT9Hv-mfTq6mZw_vupp7UlEmofvGVUb56&currency=USD">
            </script>

          <div id="paypal-container" class="payment-method">
            <div id="paypal-button-container"></div>
          </div>

          <!-- UPI Payment Section -->
          <div id="upi-container" class="mt-4 payment-method hidden text-center">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Pay with UPI</h3>

            <!-- Mobile: UPI Button -->
            <div id="upi-mobile" class="hidden">
              <a id="upi-link" class="inline-block bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                href="#">
                Pay with UPI App
              </a>
            </div>

            <!-- Desktop: QR Code -->
            <div id="upi-desktop" class="hidden text-center">
              <p class="text-gray-600 mb-2">Scan this QR code with your UPI app:</p>
              <img id="upi-qr" class="mx-auto border p-2 rounded-lg shadow" alt="UPI QR Code" />
            </div>

            <button onclick="handleUPI()" class="bg-blue-600 text-white px-4 py-2 rounded mt-12">
              Once Paid, Click Here to Confirm
            </button>
          </div>

          <div id="cod-container" class="payment-method hidden text-center">
            <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="handleCOD()">
              Place Order (COD)
            </button>
          </div>

          <script>
            const radios = document.querySelectorAll('input[name="payment_option"]');
            const methods = document.querySelectorAll('.payment-method');
            const totalAmount = "{{ grand_total|floatformat:2|unlocalize }}";

            radios.forEach(radio => {
              radio.addEventListener('change', function () {
                methods.forEach(m => m.classList.add('hidden'));
                if (this.value === "paypal") {
                  document.getElementById("paypal-container").classList.remove("hidden");
                } else if (this.value === "upi") {
                  document.getElementById("upi-container").classList.remove("hidden");
                  updateUPILink(totalAmount);
                } else if (this.value === "cod") {
                  document.getElementById("cod-container").classList.remove("hidden");
                }
              });
            });

            // ======= UPI Setup =======
            function updateUPILink(amount) {
              let upiID = "shobipri57@okhdfcbank"; // replace with vendor's UPI ID
              let name = "SMK - Beads and Crafts";
              let txnId = "TXN" + Date.now();
              let note = "Order Payment";

              let upiUrl = `upi://pay?pa=${upiID}&pn=${encodeURIComponent(name)}&tid=${txnId}&tn=${note}&am=${amount}&cu=INR`;

              document.getElementById("upi-link").href = upiUrl;
              const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiUrl)}`;

              // Detect mobile vs desktop
              const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

              if (isMobile) {
                document.getElementById("upi-mobile").classList.remove("hidden");
                document.getElementById("upi-link").setAttribute("href", upiURL);
              } else {
                document.getElementById("upi-desktop").classList.remove("hidden");
                document.getElementById("upi-qr").setAttribute("src", qrURL);
              }
            }

            function handleUPI() {
              fetch("{% url 'payments' %}", {
                method: "POST",
                headers: {
                  "X-CSRFToken": "{{ csrf_token }}",
                  "Content-type": "application/json"
                },
                body: JSON.stringify({
                  orderID: "{{ order.order_number }}",
                  transID: "UPI-" + Date.now(),
                  payment_method: "UPI",
                  status: "Pending"
                })
              })
                .then(response => response.json())
                .then(data => {
                  if (data.status === "success") {
                    window.location.href = "{% url 'order_complete' %}" +
                      '?order_number=' + data.order_number + '&payment_id=' + data.trans_ID;
                  }
                });
            }

            // ======= COD Handling =======
            function handleCOD() {
              fetch("{% url 'payments' %}", {
                method: "POST",
                headers: {
                  "X-CSRFToken": "{{ csrf_token }}",
                  "Content-type": "application/json"
                },
                body: JSON.stringify({
                  orderID: "{{ order.order_number }}",
                  transID: "COD-" + Date.now(),
                  payment_method: "COD",
                  status: "Pending"
                })
              })
                .then(response => response.json())
                .then(data => {
                  if (data.status === "success") {
                    window.location.href = "{% url 'order_complete' %}" +
                      '?order_number=' + data.order_number + '&payment_id=' + data.trans_ID;
                  }
                });
            }

            function getCookie(name) {
              var cookieValue = null;
              if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                  var cookie = cookies[i].trim();
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                  }
                }
              }
              return cookieValue;
            }
            var csrftoken = getCookie('csrftoken');

            var orderID = "{{ order.order_number }}";

            paypal.Buttons({

              style: {
                color: 'blue',
                shape: 'rect',
                label: 'pay',
                height: 40
              },

              createOrder: function (data, actions) {
                return actions.order.create({
                  purchase_units: [{
                    amount: {
                      value: '{{ grand_total|floatformat:2 }}'
                    }
                  }]
                });
              },
              onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                  fetch("{% url 'payments' %}", {
                    method: "POST",
                    headers: {
                      "X-CSRFToken": csrftoken,
                      "Content-type": "application/json"
                    },
                    body: JSON.stringify({
                      orderID: orderID,
                      transID: details.id,
                      payment_method: "PayPal",
                      status: details.status
                    })
                  })
                    .then(response => response.json())
                    .then(data => {
                      console.log("Order Details : ", data);
                      if (data.status === "success") {
                        window.location.href = "{% url 'order_complete' %}" + '?order_number=' + data.order_number + '&payment_id=' + data.trans_ID;
                      }
                    });
                });
              },
              onError: function (err) {
                console.error(err);
                alert("Something went wrong with the payment. Please try again.");
              }
            }).render('#paypal-button-container');
          </script>

        </div>
      </div>

    </div>
  </div>
</section>

{% endblock %}