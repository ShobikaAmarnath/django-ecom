{% load static %}
{% load custom_filters %}

<header class="bg-bg-main shadow-soft-lg sticky top-0 z-50 transition-colors duration-300">

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16 md:h-20">

      <!-- Left: Logo + Mobile Menu Button -->
      <div class="flex items-center gap-2">
        <button id="mobile-menu-button"
          class="md:hidden p-2 rounded-md text-text-main hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary transition">
          <i class="fa fa-bars text-xl sm:text-2xl"></i>
        </button>
        <a href="{% url 'home' %}" class="flex items-center">
          <img class="h-8 sm:h-10 md:h-12 w-auto" src="{% static 'images/logo.jpg' %}" alt="GreatKart">
        </a>
      </div>

      <!-- Middle: Categories + Store links (desktop only) -->
      <div class="hidden md:flex items-center space-x-4 lg:space-x-6">
        <!-- Categories Dropdown -->
        <div class="relative group">
          <button
            class="btn-primary px-4 py-2 rounded-md flex items-center text-sm font-medium shadow-soft-lg">
            <i class="fa fa-th-list mr-2"></i>
            All Categories
            <i
              class="fa fa-chevron-down ml-2 transform transition-transform duration-300 group-hover:rotate-180"></i>
          </button>
          <div
            class="absolute hidden group-hover:block bg-bg-main shadow-elevated rounded-xl mt-2 py-2 w-56 z-50 animate-fade-in-up max-h-96 overflow-y-auto">
            {% for category in links %}
            <a class="block px-4 py-2 text-text-main hover:bg-primary hover:text-white transition"
              href="{{ category.get_url }}">
              {{ category.category_name }}
            </a>
            {% endfor %}
          </div>
        </div>

        <!-- Store link -->
        <a href="{% url 'store' %}"
          class="btn-ghost border border-primary px-4 py-2 rounded-md hover:bg-primary hover:text-white">
          Store
        </a>
      </div>

      <!-- Desktop Search -->
      <div class="flex-1 max-w-lg mx-8 hidden lg:block">
        <form action="{% url 'store' %}" method="GET" class="relative flex items-center">
          <input type="text"
            class="form-input flex-1 rounded-l-full border border-slate-300 px-4 py-2 text-sm focus:ring-primary"
            placeholder="Search products..." name="keyword">
          <button type="submit"
            class="btn-primary rounded-r-full px-5 py-2 flex items-center justify-center">
            <i class="fa fa-search"></i>
          </button>
        </form>
      </div>

      <!-- Right: Actions -->
      <div class="flex items-center space-x-2 sm:space-x-4">

        <!-- Theme toggle (already functional here) -->
        <button id="theme-toggle"
          class="p-2 rounded-md text-text-main hover:text-primary transition-colors duration-200">
          <i id="theme-icon" class="fa fa-moon text-xl sm:text-2xl"></i>
        </button>

        {% if user.id is None %}
        <!-- Guest -->
        <a href="{% url 'login' %}"
          class="btn-primary hidden sm:block px-4 py-2 rounded-full text-sm font-semibold">
          Sign in
        </a>
        <a href="{% url 'login' %}" class="md:hidden p-2 text-text-main hover:text-primary transition">
          <i class="fa fa-user text-xl sm:text-2xl"></i>
        </a>
        {% else %}
        <!-- Authenticated User Menu -->
        <div id="user-menu-container" class="relative">
          <div id="user-menu-button"
            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full overflow-hidden cursor-pointer border-2 border-transparent hover:border-primary transition">
            {% if user.userprofile.profile_picture %}
            <img src="{{ user.userprofile.profile_picture.url }}" alt="Profile Picture"
              class="w-full h-full object-cover">
            {% else %}
            <img src="{{ user|ui_avatar:100 }}" alt="Default Avatar" class="w-full h-full object-cover">
            {% endif %}
          </div>
          <div id="user-menu-dropdown"
            class="absolute right-0 mt-2 w-56 bg-bg-main shadow-elevated rounded-xl hidden z-50 animate-fade-in-up origin-top-right">
            <div class="px-4 py-3 border-b border-slate-300">
              <p class="font-bold text-text-main">{{ user.first_name }} {{ user.last_name }}</p>
              <p class="text-sm text-text-muted">{{ user.email }}</p>
            </div>
            <ul class="py-2">
              <li>
                <a href="{% url 'dashboard' %}"
                  class="flex items-center px-4 py-2 hover:bg-primary hover:text-white transition">
                  <i class="fa fa-tachometer-alt mr-2"></i>Dashboard
                </a>
              </li>
              <li>
                <a href="{% url 'logout' %}"
                  class="flex items-center px-4 py-2 hover:bg-danger hover:text-white transition">
                  <i class="fa fa-sign-out-alt mr-2"></i>Logout
                </a>
              </li>
            </ul>
          </div>
        </div>
        {% endif %}

        <!-- Wishlist -->
        <a href="{% url 'wishlist' %}"
          class="relative p-2 text-text-muted hover:text-primary transition">
          <i class="fa fa-heart text-xl sm:text-2xl"></i>
          {% if wishlist_count > 0 %}
          <span
            class="absolute top-0 right-0 bg-danger text-white text-xs rounded-full h-4 w-4 flex items-center justify-center transform -translate-y-1/2 translate-x-1/2">
            {{ wishlist_count }}
          </span>
          {% endif %}
        </a>

        <!-- Cart -->
        <a href="{% url 'cart' %}"
          class="relative p-2 text-text-muted hover:text-primary transition">
          <i class="fa fa-shopping-cart text-xl sm:text-2xl"></i>
          {% if cart_count > 0 %}
          <span
            class="absolute top-0 right-0 bg-danger text-white text-xs rounded-full h-4 w-4 flex items-center justify-center transform -translate-y-1/2 translate-x-1/2">
            {{ cart_count }}
          </span>
          {% endif %}
        </a>
      </div>
    </div>
  </div>

  <!-- Mobile search (always visible under navbar on small screens) -->
  <div class="md:hidden bg-surface-muted border-t border-slate-300 px-4 py-2">
    <form action="{% url 'store' %}" method="GET" class="flex items-center">
      <input type="text"
        class="form-input flex-1 rounded-l-full border border-slate-300 px-4 py-2 text-sm focus:ring-primary"
        placeholder="Search products..." name="keyword">
      <button type="submit" class="btn-primary rounded-r-full px-4 py-2 flex items-center justify-center">
        <i class="fa fa-search"></i>
      </button>
    </form>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="bg-bg-main md:hidden hidden animate-fade-in-up">
    <div class="px-4 py-4 border-t border-slate-300 space-y-3">

      <a href="{% url 'store' %}"
        class="block px-4 py-2 text-text-main rounded-lg hover:bg-primary hover:text-white transition">
        <i class="fa fa-store-alt mr-2"></i>Store
      </a>

      <!-- Categories -->
      <div class="relative">
        <button id="mobile-categories-button"
          class="w-full flex items-center justify-between px-4 py-2 text-text-main rounded-lg hover:bg-primary hover:text-white transition">
          <span class="flex items-center"><i class="fa fa-th-list mr-2"></i>Categories</span>
          <i class="fa fa-chevron-down text-xs ml-2 transition-transform duration-300"></i>
        </button>
        <div id="mobile-categories-menu"
          class="pl-6 mt-2 hidden animate-fade-in-up max-h-80 overflow-y-auto space-y-1">
          {% for category in links %}
          <a class="block px-4 py-2 text-text-muted hover:bg-primary hover:text-white rounded-lg"
            href="{{ category.get_url }}">
            {{ category.category_name }}
          </a>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
</header>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileCategoriesButton = document.getElementById('mobile-categories-button');
        const mobileCategoriesMenu = document.getElementById('mobile-categories-menu');
        const userMenuContainer = document.getElementById('user-menu-container');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        // --- Mobile Menu Toggling ---
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        mobileCategoriesButton.addEventListener('click', () => {
            const chevron = mobileCategoriesButton.querySelector('i:last-child');
            mobileCategoriesMenu.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        });

        // Close mobile menu on resize to desktop view
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                mobileMenu.classList.add('hidden');
            }
        });

        // --- Desktop User Menu with Hover Delay ---
        let userMenuTimeout;

        if (userMenuContainer) {
            userMenuContainer.addEventListener('mouseenter', () => {
                clearTimeout(userMenuTimeout);
                userMenuDropdown.classList.remove('hidden');
            });

            userMenuContainer.addEventListener('mouseleave', () => {
                userMenuTimeout = setTimeout(() => {
                    userMenuDropdown.classList.add('hidden');
                }, 300); // 300ms delay
            });
        }

        // --- Mobile User Menu with Click Toggle ---
        if (userMenuButton) {
            userMenuButton.addEventListener('click', () => {
                userMenuDropdown.classList.toggle('hidden');
            });
        }


        // Close user dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (userMenuContainer) {
                const isClickInside = userMenuContainer.contains(event.target);
                const isDropdownVisible = !userMenuDropdown.classList.contains('hidden');

                if (!isClickInside && isDropdownVisible) {
                    userMenuDropdown.classList.add('hidden');
                }
            }
        });

        // --- Dark Mode Functionality ---
        const root = document.documentElement;
        
        // Initial theme setup
        const isDarkMode = localStorage.getItem('theme') === 'dark' || (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('theme'));
        
        if (isDarkMode) {
            root.classList.add('dark');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        } else {
            root.classList.remove('dark');
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
        }

        themeToggle.addEventListener('click', () => {
            root.classList.toggle('dark');
            if (root.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                localStorage.setItem('theme', 'light');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        });
    });
</script>